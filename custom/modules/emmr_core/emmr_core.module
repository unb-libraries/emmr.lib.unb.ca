<?php

/**
 * @file
 * Contains emmr_core.module.
 */

 use Drupal\block\Entity\Block;

/**
 * Implements hook_preprocess_hook().
 */
function emmr_core_preprocess_emmr_intro(&$variables) {
  $block = Block::load('exposedformemmr_browse_recipespage_2');
  $variables['search_block_output'] = \Drupal::entityTypeManager()
    ->getViewBuilder('block')
    ->view($block);
}

/**
 * Implements hook_theme().
 */
function emmr_core_theme($existing, $type, $theme, $path) {
  return [
    'emmr_intro' => [
      'variables' => [],
    ],
  ];
}

/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function emmr_core_node_presave($node) {
  // Generate mid date on recipe save.
  if ($node->bundle() == "emmr_recipe") {

    if ($node->get('field_recipe_date_to')->getValue()) {
      $date = strtotime($node->get('field_recipe_date')->getValue()[0]['value']);
      $date_to = strtotime($node->get('field_recipe_date_to')
        ->getValue()[0]['value']);
      $date_mid = date("Y-m-d", ($date + $date_to) / 2);

      $node->get('field_recipe_date_mid')->setValue($date_mid);
    }
    else {
      $node->get('field_recipe_date_mid')->setValue("");
    }
  }
}

/**
 * Implements hook_FORM_ID_alter().
 */
function emmr_core_form_alter(&$form,
  &$form_state,
  $form_id) {

  if ($form_id == "node_emmr_recipe_form" ||
  $form_id == "node_emmr_recipe_edit_form") {

    $form['date_range'] = [
      '#type' => 'checkbox',
      '#title' => t('Imprecise Date'),
      '#weight' => 6,
    ];

    $form['field_recipe_date_to']['#states']['invisible'][':input[name="date_range"]']
      = ['checked' => FALSE];
    $form['field_recipe_date_to']['#states']['enabled'][':input[name="date_range"]']
      = ['checked' => TRUE];
  }
}
